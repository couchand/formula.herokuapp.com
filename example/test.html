<html>
    <head>
        <style>
            table {
                border: thick solid black;
                display: inline-block;
            }
            th, td {
                border: thin solid gray;
                padding: 5px 15px;
                margin: 0;
            }
            .failure {
                background-color: red;
            }
            #data {
                height: 33%;
            }
            #dataGrid {
                height: 20%;
                width: 100%;
            }
        </style>
        <link rel="stylesheet" href="navbar.css">
        <link rel="stylesheet" href="console.css">
        <link rel="stylesheet" href="layout.css">
        <link rel="stylesheet" href="lib/slick.grid.css">
        <link rel="stylesheet" href="lib/examples.css">
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type="text/javascript" src="lib/jquery.event.drag.js"></script>
        <script type="text/javascript" src="lib/jquery.event.drop.js"></script>
        <script type="text/javascript" src="http://raw.github.com/mleibman/SlickGrid/master/slick.core.js"></script>
        <script type="text/javascript" src="http://raw.github.com/mleibman/SlickGrid/master/slick.grid.js"></script>
        <script>
            var module = {}
        </script>
        <script type="text/javascript" src="parser.js"></script>
        <script type="text/javascript" src="printer.js"></script>
        <script>
            var stringify = module.exports;
        </script>
        <script type="text/javascript" src="nodes.js"></script>
        <script type="text/javascript" src="persist.js"></script>
        <script>
            parser.yy = module.exports;
            var slickgrid;

            function isValid( text ) {
                var console = document.getElementById('console'),
                    consoleText = document.getElementById('consoleText');

                consoleText.innerHTML = '';
                console.className = '';
                try {
                    parser.parse( text );
                    return true;
                }
                catch (ex) {
                    consoleText.innerHTML = '' + ex;
                    console.className = 'err';
                }
                return false;
            }

            function field( property ) {
                return {
                    minWidth: property == "message" ? 60 : 30,
                    name: property,
                    field: property,
                    id: property
                };
            }

            function getTemplate() {
                var formula = $('#src').val();

                if ( !isValid( formula ) ) {
                    return;
                }

                saveFormula(formula);

                $.get('test', { formula: formula }, function( template ) {
                    $('#data').val( template );
                });
            }
            function runTests() {
                var formula = $('#src').val();
                var data = $('#data').val();
                var columns = [], rows = [];

                if ( !isValid( formula ) ) {
                    return;
                }

                saveFormula(formula);

                $.get('test', { formula: formula, data: data }, function( results ) {
                    var resultTable = $('#results').empty();
                    var row = $('<tr>');

                    columns.push( field( 'message' ) );

                    $.each( results[0], function(property, value) {
                        row.append( $('<th>').text( property ) );

                        if ( property !== 'expected' && property !== 'actual' && property !== 'message' ) {
                            columns.push( field( property ) );
                        }
                    });
                    row.appendTo( resultTable );

                    columns.push( field( 'expected' ) );
                    columns.push( field( 'actual' ) );

                    $.each( results, function (index, result) {
                        var row = $('<tr>'), dataRow = {};

                        row.append( $('<td>').text( result.message ) );

                        $.each( result, function(property, value) {
                            dataRow[property] = value;

                            if ( property !== 'expected' && property !== 'actual' && property !== 'message' ) {
                                row.append( $('<td>').text( value ) );
                            }
                        });

                        row.append( $('<td>').text( result.expected ) );

                        var actual = $('<td>').text( result.actual );
                        if ( result.actual !== result.expected ) {
                            actual.addClass('failure');
                        }
                        row.append( actual );

                        rows.push( dataRow );
                        row.appendTo( resultTable );
                    });

                    slickgrid = new Slick.Grid('#dataGrid', rows, columns, {
                        enableColumnReorder: false
                    });
                });
            }
        </script>
    </head>
    <body onLoad="loadFormula(getTemplate);">
        <a href="https://github.com/couchand/force-formula"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>
        <div id="navbar">
            <ul>
                <li><a href="prettyprint.html">Pretty Printer</a></li>
                <li><a href="tree.html">Tree Visualization</a></li>
                <li class="active"><a href="test.html">Unit Test Console</a></li>
            </ul>
        </div>
        <div class="column io">
            <div class="columnContent">
                <textarea id="src"></textarea>
            </div>
            <button onClick="runTests();">Run Tests</button>
            <button onClick="getTemplate();">Get Template</button>
        </div>
        <div class="column2 io">
            <div class="columnContent">
                <div class="description">
                    <h2>Unit Testing</h3>
                    <p>Testing is an important part of ensuring quality.  Comprehensive unit tests allow you to refactor mercilessly without worrying about breaking functionality.</p>
                </div>
                <div id="dataGrid"></div>
                <textarea id="data"></textarea>
                <table id="results" cellspacing="0"></table>
            </div>
        </div>
        <div id="console"><pre><span id="consoleText"></span></pre></div>
        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-40537296-1']);
          _gaq.push(['_trackPageview']);
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>
    </body>
</html>
